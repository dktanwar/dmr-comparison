---
title: "pWGBSSimla: generating input for various software"
author: "Deepak Tanwar"
date: "<b>Created on:</b> 2020-02-13 <br> <b>Updated on:</b> `r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: tango
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    keep_md: no
    number_sections: no
    fig_width: 8
    fig_height: 8
    fig_caption: true
    df_print: paged
    code_folding: show
  fontsize: 12pt
  geometry: margin=1in
  documentclass: article
# bibliography: references.bib
link-citations: yes
---

# Packages required
```{r 20200213-generate-input-datasets-1, message=F, warning=F}
library(data.table)
library(dmrseq)
```

# Read data in R

## Simulated data
```{r 20200213-generate-input-datasets-2}
# Files from 10 replicates
files.sim <- list.files(path = "./input", pattern = "sim", full.names = T)

# Read data
read.sim <- lapply(files.sim, function(x) {
  fread(
    input = x, sep = "\t", data.table = F,
    header = F, stringsAsFactors = F,
    col.names = c("chr", "pos", "M", "cov")
  )
})

names(read.sim) <- sapply(files.sim, function(x) strsplit(x, "\\.|/")[[1]][4])
```

Different software needs input to be in different formats. In the next section, we are generating all types of input.


# Creating various formats of input data

## Bismark `cov`
```{r 20200213-generate-input-datasets-3}
bismark.sim <- lapply(read.sim, function(x) {
  a <- x
  a$percent <- (a$M / a$cov) * 100
  a$Un <- a$cov - a$M
  a$pos1 <- a$pos
  return(a[, c("chr", "pos", "pos1", "percent", "M", "Un")])
})
```

### Save data
```{r 20200213-generate-input-datasets-4}
system("mkdir -p ./output/bismark")
for (i in 1:length(read.sim)) {
  fwrite(
    x = bismark.sim[[i]],
    file = paste0("./output/bismark/", names(read.sim)[i], ".cov"),
    sep = "\t", quote = F, row.names = F, col.names = F
  )
}
```


## Methpipe inputs
```{r 20200213-generate-input-datasets-5}
methpipe.sim <- lapply(read.sim, function(x) {
  a <- x
  a$strand <- "*"
  a$CG <- "CpG"
  a$percent <- (a$M / a$cov)
  return(a[, c("chr", "pos", "strand", "CG", "percent", "cov")])
})
```

### Save data
```{r 20200213-generate-input-datasets-6}
system("mkdir -p ./output/methpipe")
for (i in 1:length(read.sim)) {
  fwrite(
    x = methpipe.sim[[i]],
    file = paste0("./output/methpipe/", names(read.sim)[i], ".cov"),
    sep = "\t", quote = F, row.names = F, col.names = F
  )
}
```



## CGmapTools inputs
```{r 20200213-generate-input-datasets-7}
cgmap.sim <- lapply(read.sim, function(x) {
  a <- x
  a$nuc <- "C"
  a$cont <- "CG"
  a$dinuc <- "CG"
  a$meth <- a$M / a$cov
  return(a[, c("chr", "nuc", "pos", "cont", "dinuc", "meth", "M", "cov")])
})
```

### Save data
```{r 20200213-generate-input-datasets-8}
system("mkdir -p ./output/cgmaptools")
for (i in 1:length(read.sim)) {
  fwrite(
    x = cgmap.sim[[i]],
    file = paste0("./output/cgmaptools/", names(read.sim)[i], ".cov"),
    sep = "\t", quote = F, row.names = F, col.names = F
  )
}
```


## DMRcaller inputs
```{r 20200213-generate-input-datasets-9}
dmrcaller.sim <- lapply(read.sim, function(x) {
  a <- x
  a$strand <- "+"
  a$cont <- "CG"
  a$dinuc <- "XCG"
  a$Un <- a$cov - a$M
  return(a[, c("chr", "pos", "strand", "M", "Un", "cont", "dinuc")])
})
```

### Save data
```{r 20200213-generate-input-datasets-10}
system("mkdir -p ./output/dmrcaller")
for (i in 1:length(read.sim)) {
  fwrite(
    x = dmrcaller.sim[[i]],
    file = paste0("./output/dmrcaller/", names(read.sim)[i], ".cov"),
    sep = "\t", quote = F, row.names = F, col.names = F
  )
}
```


Also, we are making one table with coverage and methylation values.

# One table for Coverage and Methylation

```{r 20200213-generate-input-datasets-11, warning=F}
# Make one dataframe fromlist of files
tab.sim <- Reduce(function(x, y) {
  merge(x, y, by = c("chr", "pos"))
}, read.sim)

tab.sim <- tab.sim[order(tab.sim$pos), ]

tab.sim.M <- tab.sim[, grep(pattern = "chr|pos|M", x = colnames(tab.sim))]
colnames(tab.sim.M)[3:ncol(tab.sim.M)] <- names(read.sim)
fwrite(
  x = tab.sim.M, file = "./output/simulated_data.M",
  quote = F, sep = "\t", row.names = F
)


tab.sim.cov <- tab.sim[, grep(pattern = "chr|pos|cov", x = colnames(tab.sim))]
colnames(tab.sim.cov)[3:ncol(tab.sim.cov)] <- names(read.sim)
fwrite(
  x = tab.sim.cov, file = "./output/simulated_data.cov",
  quote = F, sep = "\t", row.names = F
)
```


# Compress all text outputs
```{r 20200213-generate-input-datasets-12}
system("pigz -11 -p 16 ./output/*")
system("pigz -11 -p 16 ./output/*/*")
```


# SessionInfo
```{r 20200213-generate-input-datasets-13}
devtools::session_info()
```
